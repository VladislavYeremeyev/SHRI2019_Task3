# Задание 3. Найдите ошибки

В этом репозитории находятся материалы тестового задания «Найди ошибки» для [15-й Школы разработки интерфейсов](https://yandex.ru/promo/academy/shri) (осень 2019, Москва).

Для работы приложения нужен [Node.JS](https://nodejs.org/en/) v10 или выше, а также редактор [VS Code](https://code.visualstudio.com).

## Задание

**Вам дан исходный код приложения, в котором есть ошибки. Некоторые из них стилистические, а другие даже не позволят запустить приложение. Вам нужно найти все ошибки и исправить их.**

Тестовое приложение — это плагин VS Code для удобного прототипирования интерфейсов с помощью дизайн-системы из первого задания. Вы можете описать в файле `.json` блоки, из которых состоит интерфейс. Плагин добавляет превью (1) и линтер (2) для структуры блоков.

![скриншот интерфейса](screens/extension.png)

### 1. Превью интерфейса

- Превью интерфейса доступно для всех файлов `.json`.
- Превью открывается в отдельной вкладке:
  - при выполнении команды `Example: Show preview` через палитру команд;
  - при нажатии кнопки сверху от редактора (см. скриншот);
  - при нажатии горячих клавиш **⌘⇧V** (для macOS) или **Ctrl+Shift+V** (для Windows).
- Вкладка превью должна открываться рядом с текущим редактором.
- Если превью уже открыто, то вместо открытия ещё одной вкладки пользователь должен переходить к уже открытой.
- При изменении структуры блоков в редакторе превью должно обновляться.
- Сейчас превью отображает структуру блоков в виде прямоугольников — реализуйте отображение превью с помощью вёрстки и JS из первого задания.

### 2. Линтер структуры блоков

- Линтер применяется для всех файлов `.json`.
- Линтер подсвечивает ошибочное место в файле и отображает сообщение при наведении мыши.
- Линтер отображает сообщения на панели `Problems` (**⌘⇧M** для macOS или **Ctrl+Shift+M** для Windows), сообщения группируются по файлам, при клике происходит переход к ошибочному месту.
- Сейчас плагин использует линтер-заглушку, проверяющий всего два правила: 1) «запрещены названия полей в верхнем регистре»; 2) «в каждом объекте должно быть поле `block`». Подключите в проект линтер из второго задания.

### 3. Настройки

Плагин добавляет в настройки VS Code новый раздел `Example` с параметрами:

- `example.enable` — использовать линтер;
- `example.severity.uppercaseNamesIsForbidden` — тип сообщения для правила «запрещены названия полей в верхнем регистре»;
- `example.severity.blockNameIsRequired` — тип сообщения для правила «в каждом объекте должно быть поле `block`».

Типы сообщений: `Error`, `Warning`, `Information`, `Hint`.

При изменении конфигурации новые настройки должны применяться к работе линтера.

## Как запустить

1. Открыть проект в VS Code.
2. Запустить `npm i`.
3. Нажать `F5`.

Должно открыться ещё одно окно VS Code с подключённым плагином.

## Что мы проверяем этим заданием

В этом задании мы хотим проверить вашу способность разобраться в незнакомом коде и API, а также ваш навык отладки. Пожалуйста, опишите в коде или файле README ход ваших мыслей: какие ошибки и как вы нашли, почему они возникли, какие способы их исправления существуют. Мы не ограничиваем вас в использовании сторонних инструментов и библиотек, но будем ждать от вас комментария — что и зачем вы использовали.

## Выполнение задания

### 1. Плагин запускается в рабочем режиме

#### Сообщение об ошибке при запуске расширения

```vscode-error
[undefined_publisher.shri-ext]: Menu item references a command `example.showPreviewToSide` which is not defined in the 'commands' section.
```

#### Описание решения

По сообщению ошибки понимаем, что не найдена команда `example.showPreviewToSide`. Просматривая `package.json`, замечаем, что в блоке с командами есть опечатка (v вместо w) - `example.showPrevievToSide`. После исправления расширение запускается.

### 2. Работает перечисленный в условии функционал

### 2.1 Превью интерфейса

Возможность открыть превью присутствует у всех файлов с расширением `.json`. Также превью открывается всем тремя перечисленными в условии способами.

#### Вкладка превью должна открываться рядом с текущим редактором

Изначально превью открывается в отдельной колонке окна редактора (как на скриншоте с описанием задания). Требование, что вкладка превью должна открываться рядом с текущим редактором, я понял так, что при запуске команды открытия превью, оно открывается в соседней вкладке в той же колонке окна редактора.

#### Описание решения

В файле `extension.ts` присутствует следующий код:

```ts
const initPreviewPanel = (document: vscode.TextDocument) => {
    const fileName = basename(document.fileName);

    const panel = vscode.window.createWebviewPanel(
        'example.preview',
        `Preview: ${fileName}`,
        vscode.ViewColumn.Beside,
        {
            enableScripts: true
        }
    );

    PANELS[document.uri.path] = panel;

    const e = panel.onDidDispose(() => {
        delete PANELS[document.uri.path];
        e.dispose();
    });

    return panel;
};
```

В методе `createWebviewPanel` третьим параметром передаются опции показа (`showOptions`), такие как фокусировка на новом webview, а также локация webview в окне редактора. Изначально указан параметр `vscode.ViewColumn.Beside`, который открывает webview в соседней с активной вкладкой колонке. При изменении значения на `vscode.ViewColumn.Active`, webview будет открываться рядом в той же колонке окна редактора, что и активная вкладка.

**UPD (24.06.19):**

Всё-таки решил оставить `vscode.ViewColumn.Beside`, так как с точки зрения UX это является более удобным, когда изменяя файл, сразу видишь измененное Preview и нет необходимости переключаться между вкладками.

---

#### Если превью уже открыто, то вместо открытия ещё одной вкладки пользователь должен переходить к уже открытой

#### Описание решения

В файле `extension.ts` присутствует следующий код:

```ts
const openPreview = (context: vscode.ExtensionContext) => {
    const editor = vscode.window.activeTextEditor;

    if (editor !== undefined) {
        const document: vscode.TextDocument = editor.document;

        const path = document.uri.toString();
        const panel = PANELS[path];

        if (panel) {
            panel.reveal();
        } else {
            const panel = initPreviewPanel(document);
            setPreviewContent(document, context);
            context.subscriptions.push(panel);
        }
    }
};
```

В конце кода присутствует условие на проверку открыта ли уже вкладка с превью, но при этом превью все равно открывается каждый раз в новой вкладке. При дебаге замечаем, что `document.uri.toString()` возвращает строку вида `"file:///{path}/{fileName}.json"`, то есть в этой строке присутсвует URI `scheme` параметр, в данном случае со значением `file`.

При этом в этом же файле `extension.ts` в `initPreviewPanel` при запуске команды открытия preview создается панель с webview и в объект `PANELS` записывается переменная панели по ключу `document.uri.path`, который имеет вид `"/{path}/{fileName}.json"`:

```ts
const initPreviewPanel = (document: vscode.TextDocument) => {
    const fileName = basename(document.fileName);

    const panel = vscode.window.createWebviewPanel(
        'example.preview',
        `Preview: ${fileName}`,
        vscode.ViewColumn.Active,
        {
            enableScripts: true
        }
    );

    PANELS[document.uri.path] = panel;

    const e = panel.onDidDispose(() => {
        delete PANELS[document.uri.path];
        e.dispose();
    });

    return panel;
};
```

Именно поэтому в условии никогда не находится существующая вкладка, так как происходит поиск по неверному ключу.

Если исправить `const path = document.uri.toString();` на `const path = document.uri.path;` или `const path = document.uri.fsPath;` (**.fsPath** отличается от **.path** тем, что использует специфичные для платформ разделители в путях, а также обработку **UNC** (Universal Naming Convention) путей), то плагин будет работать корректно.

---

#### При изменении структуры блоков в редакторе превью должно обновляться

При запуске превью отображается некорректно.

#### Описание решения

Убрал лишний отступ в `div` в файле `preview/style.css`.

Запускаем расширение, открываем превью и используем команду **Developer: Open Webview Developer Tools** для дебага webview.
Dev Tools показывает следующие ошибки:

![скриншот WebView](screens/screenshot_webview.png)

По ошибкам замечаю, что в `preview/index.html` в атрибуте `nonce` вместо английского символа `c`, написана русская буква `c`. Также, как описано в [документации](https://code.visualstudio.com/api/extension-guides/webview#loading-local-content) webview, webview запускаются в изолированном контексте и в целях безопасности не могут напрямую получать доступ к локальным ресурсам. Поэтому нужно использовать схему `vscode-resource:` внутри webview. Поэтому в директиве `style-src` добавил `vscode-resource:`.

Еще добавил пропущенный `/` в строке `<base href="{{mediaPath}}/">`

В файле `preview/style.css` убрал фиксированную ширину (`width: 100px`) у `div`, чтобы preview корректно отображалось.

Результат:

![скриншот WebView](screens/screenshot_preview.png)
